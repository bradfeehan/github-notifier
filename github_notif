#!/bin/bash

readonly JQ=jq
readonly DIR_NAME=$(dirname $BASH_SOURCE)
readonly LATEST_ID_FILE="$HOME/.latest_id"
KEEP_IN_SCREEN_TIME_IN_SECONDS=5
PATH=$PATH:/usr/local/bin

. $DIR_NAME/lib/config_accessor.sh
. $DIR_NAME/lib/logger.sh
. $DIR_NAME/lib/url.sh

function show_notification () {
  local access_token=$1
  local notifications_json=$2
  local notification_index=$3

  eval "$(echo "$notifications_json" | $JQ ".[$notification_index]" |
  $JQ -r '@sh "
  latest_comment_url=\(.subject.latest_comment_url)
  repo=\(.repository.name)
  title=\(.subject.title)
  general_url=\(.subject.url)
  notification_type=\(.subject.type)
  "')"

  notification_type=$(echo $notification_type | sed 's|PullRequest|a PR|;s|Issue|an issue|;s|Commit|a commit|')

  # sometimes latest_comment_url="null", for example when PR title is set
  [[ $latest_comment_url == "null" ]] && notification_details_url="$general_url" || notification_details_url="$latest_comment_url"

  local notification_details_json
  notification_details_json=$(do_github_remote_call $notification_details_url $access_token)
  local call_result=$?
  if [[ $call_result -ne 0 ]]; then
    echo $notification_details_json
    return 1
  fi

  eval "$(echo "$notification_details_json" | $JQ -r '@sh "
  details_user=\(.user.login)
  details_body=\(.body)
  details_html_url=\(.html_url)
  details_updated=\(.updated_at)
  details_title=\(.title)
  "')"

  echo "$notification_details_url" | grep -q 'comments'
  local call_result=$?
  if [[ $call_result -eq 0 ]]; then
    event_action='commented on'
  else
    event_action='created'
  fi

  #TODOD: my be No description provided instead
  [[ $details_body != "" ]] && body="$details_body" || body="$details_title"

  #remove '[' and '<' characters from begining of the strings
  #because of https://github.com/julienXX/terminal-notifier/issues/134
  local body=$(echo $body | sed -E 's|^[\[\<]+||')
  local title=$(echo $title | sed -E 's|^[\[\<]+||')

  terminal-notifier --group 1 -title "${details_user//\"} ${event_action} $notification_type in ${repo//\"}" -subtitle "${title//\"}" \
  -message "${body//\"}" -open ${details_html_url//\"} -appIcon $DIR_NAME/logo.png
}

function show_all_notifications () {
  config_url=$1
  terminal-notifier --group 1 -title "Missed notifications on $(get_resource_name $config_url)" \
  -subtitle "$(date)" -message "See all" -open $config_url/notifications -appIcon $DIR_NAME/logo.png
}

function get_last_shown_commit_date() {
  local config_name=$1

  if [ -f $LATEST_ID_FILE ]; then
    echo $(cat $LATEST_ID_FILE | grep -w "$config_name" | cut -d' ' -f2)
  else
    echo "0"
  fi
}

function save_last_shown_commit_date() {
  local config_name=$1
  local value=$2
  if [ -f $LATEST_ID_FILE ]; then
    local line_number=$(grep -wn "$config_name" $LATEST_ID_FILE | cut -d: -f1)
    if [[ -n "$line_number" ]]; then
      sed -i .bak "${line_number}s|.*|$config_name $value|" $LATEST_ID_FILE &&
      rm $LATEST_ID_FILE.bak
    else
      echo $config_name $value >> $LATEST_ID_FILE
    fi
  else
    echo $config_name $value >> $LATEST_ID_FILE
  fi
}

function do_github_remote_call() {
  local url=$1
  local access_token=$2
  local response
  response=$(curl -w "%{http_code}" $url -H "Authorization: token $access_token" 2>/dev/null)
  local call_result=$?
  if [[ $call_result -ne 0 ]]; then
    echo "Failed to connect to $url"
    return 1
  fi

  local response_status_code=$(echo "$response" | tail -n 1)
  local response_body=$(echo "$response" | sed \$d)
  if [[ $response_status_code != 200 ]]; then
    local error_message=$(echo "$response_body" | $JQ -r .message )
    local call_result=$?
    if [[ $call_result -ne 0 ]]; then
      echo "An error occured while accessing $url. The output of notifications is not of known format"
      return 1
    fi
    if [[ "$error_message" != "null" ]]; then
      echo "An error occured while accessing $url: $error_message"
      return 1
    fi
  fi
  echo $response_body
  return 0
}

# current implementation have limit of 2
function show_missed_notifications() {
  local config_url=$1
  local access_token=$2
  local notifications_json=$3
  local shown_id=$4

  local latest_commit_dates=( $(echo "$notifications_json" | $JQ '.[0,1,2].updated_at' | \
  egrep '[0-9]{4}-[0-9]{2}-[0-9]{2}T[0-9]{2}:[0-9]{2}:[0-9]{2}Z' | xargs -n 1 date -j -f "%Y-%m-%dT%TZ" +"%s") )

  if (( $shown_id < ${latest_commit_dates[0]:--1} )); then
    error_message=$(show_notification $access_token "$notifications_json" 0)
    local call_result=$?
    if [[ $call_result -ne 0 ]]; then
      log_error "An error occured while showing notification. $error_message"
      exit_code=1
    else
      sleep $KEEP_IN_SCREEN_TIME_IN_SECONDS
    fi
  else
    echo $shown_id
    return $exit_code
  fi

  if (( $shown_id < ${latest_commit_dates[1]:--1} )); then
    error_message=$(show_notification $access_token "$notifications_json" 1)
    local call_result=$?
    if [[ $call_result -ne 0 ]]; then
      log_error "An error occured while showing notification. $error_message"
      exit_code=1
    else
      sleep $KEEP_IN_SCREEN_TIME_IN_SECONDS
    fi
  else
    echo ${latest_commit_dates[0]}
    return $exit_code
  fi

  if (( $shown_id < ${latest_commit_dates[2]:--1} )); then
    show_all_notifications $config_url
    sleep $KEEP_IN_SCREEN_TIME_IN_SECONDS
  fi

  echo ${latest_commit_dates[0]}
  return $exit_code
}

function main() {
  exit_code=0
  local active_configs=$(get_active_configs)
  if [ -z "$active_configs" ]; then
     echo "There is no any active configuration to get notifications"
     return 1
  fi

  for config_name in $active_configs ; do
    local last_shown_commit_date=$(get_last_shown_commit_date $config_name)
    local notifications_json
    access_token=$(get_token $config_name)
    local notifications_api_url="${config_name/https:\/\//https://api.}"/notifications
    notifications_json=$(do_github_remote_call $notifications_api_url $access_token)
    local call_result=$?
    if [[ $call_result -ne 0 ]]; then
      log_error $notifications_json
      exit_code=1
      continue
    fi

    local updated_last_shown_commit_date
    updated_last_shown_commit_date=$(show_missed_notifications $config_name $access_token "$notifications_json" $last_shown_commit_date)
    local call_result=$?
    save_last_shown_commit_date $config_name $updated_last_shown_commit_date
    if [[ $call_result -ne 0 ]]; then
      log_error "Cannot save last shown commit id"
      exit_code=1
    fi
  done

  return $exit_code
}

main
