#!/bin/bash

readonly JQ=jq
readonly NOTIFICATIONS_URL='https://api.github.com/notifications' #notification api url
readonly NOTIFICATIONS_PORTAL='https://github.com/notifications' #notification portal for humans
readonly DIR_NAME=$(dirname $BASH_SOURCE)
APPLICATION_DIR=`dirname $0`
readonly LATEST_ID_FILE="$APPLICATION_DIR/.latest_id"
KEEP_IN_SCREEN_TIME_IN_SECONDS=2

. $DIR_NAME/lib/config_accessor.sh

function show_notification () {
  local access_token=$1
  local notifications_json=$2
  local notification_index=$3
  local notification_info=$(echo "$notifications_json" | $JQ ".[$notification_index].subject.latest_comment_url,.[$notification_index].repository.name,.[$notification_index].subject.title,.[$notification_index].subject.url")
  local latest_comment_url=$(echo $notification_info | cut -d'"' -f2)
  local repo=$(echo $notification_info | cut -d'"' -f4)
  local title=$(echo $notification_info | cut -d'"' -f6)
  local general_url=$(echo $notification_info | cut -d'"' -f8)

  # sometimes latest_comment_url="null", for example when PR title is set
  [[ $latest_comment_url == "null" ]] && notification_details_url="$general_url" || notification_details_url="$latest_comment_url"

  local notification_details_json;
  notification_details_json=$(do_github_remote_call $notification_details_url $access_token)
  local call_result=$?
  if [[ $call_result -ne 0 ]]; then
    echo $notification_details_json;
    return 1
  fi
  local notification_details=$(echo "$notification_details_json" | $JQ '.user.login,.body,.html_url,.updated_at,.subject,.title')

  local details_user=$(echo "$notification_details" | sed -n '1p')
  local details_body=$(echo "$notification_details" | sed -n '2p')
  local details_html_url=$(echo "$notification_details" | sed -n '3p')
  local details_updated=$(echo "$notification_details" | sed -n '4p')
  local details_title=$(echo "$notification_details" | sed -n '5p')

  [[ $details_body != "" ]] && body="$details_body" || body="$details_title"

  terminal-notifier --group 1 -title "${details_user//\"}" on ${repo//\"}" -subtitle "${title//\"}"" -message "${body//\"}" -open ${details_html_url//\"}
}

function show_all_notifications () {
  terminal-notifier --group 1 -title "Missed notifications on Github" -subtitle "$(date)" -message "See all" -open $NOTIFICATIONS_PORTAL
}

function get_last_shown_commit_id() {
  local config_name=$1

  if [ -f $LATEST_ID_FILE ]; then
    echo $(cat $LATEST_ID_FILE | grep -w "$config_name" | cut -d' ' -f2)
  else
    echo "0"
  fi
}

function save_last_shown_commit_id() {
  local config_name=$1
  local value=$2
  if [ -f $LATEST_ID_FILE ]; then
    local line_number=$(grep -wn "$config_name" $LATEST_ID_FILE | cut -d: -f1)
    if [[ -n "$line_number" ]]; then
      sed -i .bak "${line_number}s/.*/$config_name $value/" $LATEST_ID_FILE &&
      rm $LATEST_ID_FILE.bak
    else
      echo $config_name $value >> $LATEST_ID_FILE
    fi
  else
    echo $config_name $value >> $LATEST_ID_FILE
  fi
}

function do_github_remote_call() {
  local url=$1
  local access_token=$2
  local response;
  response=$(curl -w "%{http_code}" $url -H "Authorization: token $access_token" 2>/dev/null)
  local call_result=$?
  if [[ $call_result -ne 0 ]]; then
    echo "Failed to connect to $url";
    return 1
  fi

  local response_status_code=$(echo "$response" | tail -n 1)
  local response_body=$(echo "$response" | sed \$d)
  if [[ $response_status_code != 200 ]]; then
    local error_message=$(echo "$response_body" | $JQ -r .message )
    local call_result=$?
    if [[ $call_result -ne 0 ]]; then
      echo "An error occured while accessing $url. The output of notifications is not of known format"
      return 1
    fi
    if [[ "$error_message" != "null" ]]; then
      echo "An error occured while accessing $url: $error_message"
      return 1
    fi
  fi
  echo $response_body
  return 0
}

# current implementation have limit of 2
function show_missed_notifications() {
  local access_token=$1
  local notifications_json=$2
  local shown_id=$3

  local latest_commit_ids=( $(echo "$notifications_json" | $JQ '.[0,1,2].id' | tr -d '"') );

  if [[ ${latest_commit_ids[0]} != null && $shown_id != ${latest_commit_ids[0]} ]]; then
    show_notification $access_token "$notifications_json" 0
    sleep $KEEP_IN_SCREEN_TIME_IN_SECONDS
  else
    echo $shown_id
    return
  fi

  if [[ ${latest_commit_ids[1]} != null && $shown_id != ${latest_commit_ids[1]} ]]; then
    show_notification $access_token "$notifications_json" 1
    sleep $KEEP_IN_SCREEN_TIME_IN_SECONDS
  else
    echo ${latest_commit_ids[0]}
    return
  fi

  if [[ ${latest_commit_ids[2]} != null && $shown_id != ${latest_commit_ids[2]} ]]; then
    show_all_notifications
    sleep $KEEP_IN_SCREEN_TIME_IN_SECONDS
  fi

  echo ${latest_commit_ids[0]}
}

function main() {
  local active_configs=$(get_active_configs)
  if [ -z "$active_configs" ]; then
     echo "There is no any active configuration to get notifications";
     return
  fi

  for config_name in $active_configs ; do
    local last_shown_commit_id=$(get_last_shown_commit_id $config_name)
    local notifications_json;
    access_token=$(get_token $config_name)
    notifications_json=$(do_github_remote_call $NOTIFICATIONS_URL $access_token)
    local call_result=$?
    if [[ $call_result -ne 0 ]]; then
      echo $notifications_json;
      continue
    fi

    local updated_last_shown_commit_id
    updated_last_shown_commit_id=$(show_missed_notifications $access_token "$notifications_json" $last_shown_commit_id)
    local call_result=$?
    if [[ $call_result -ne 0 ]]; then
      echo $updated_last_shown_commit_id;
      return 1
    fi
    save_last_shown_commit_id $config_name $updated_last_shown_commit_id
  done
}

main
